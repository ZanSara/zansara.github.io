<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Headless WiFi setup on Raspberry Pi OS &#34;Bookworm&#34; without the Raspberry Pi Imager Â· Sara Zan
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Sara Zan">
<meta name="description" content="Setting up a headless Pi used to be simpler. Is it still possible to do it without the RPi Imager?">
<meta name="keywords" content="blog,developer,personal,python,llm,nlp,swe,software-engineering,open-source,ai,genai">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Headless WiFi setup on Raspberry Pi OS &#34;Bookworm&#34; without the Raspberry Pi Imager">
  <meta name="twitter:description" content="Setting up a headless Pi used to be simpler. Is it still possible to do it without the RPi Imager?">

<meta property="og:url" content="https://www.zansara.dev/posts/2024-01-06-raspberrypi-headless-bookworm-wifi-config/">
  <meta property="og:site_name" content="Sara Zan">
  <meta property="og:title" content="Headless WiFi setup on Raspberry Pi OS &#34;Bookworm&#34; without the Raspberry Pi Imager">
  <meta property="og:description" content="Setting up a headless Pi used to be simpler. Is it still possible to do it without the RPi Imager?">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-01-06T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-06T00:00:00+00:00">


<meta name="msvalidate.01" content="CD2BB9B57B16AF914327870432D856C1" />
<meta name="yandex-verification" content="a886d3d5d2b57cb5" />


<link rel="canonical" href="https://www.zansara.dev/posts/2024-01-06-raspberrypi-headless-bookworm-wifi-config/">


<link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>


  <link rel="stylesheet" href="/css/coder.css" crossorigin="anonymous" media="screen" />






  
    <link rel="stylesheet" href="/css/coder-dark.css" crossorigin="anonymous" media="screen" />
  



 

<link rel="icon" type="image/svg+xml" href="/me/avatar.svg" sizes="any">
<link rel="icon" type="image/png" href="/me/avatar.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/me/avatar.png">
<link rel="apple-touch-icon" sizes="180x180" href="/me/avatar.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">










  
  <meta name="image" content="/posts/2024-01-06-raspberrypi-headless-bookworm-wifi-config/cover.png">
  <meta name="og:image" content="/posts/2024-01-06-raspberrypi-headless-bookworm-wifi-config/cover.png">
  <meta name="twitter:image" content="https://zansara.dev/posts/2024-01-06-raspberrypi-headless-bookworm-wifi-config/cover.png">
  

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+HK:wght@200..900&family=Noto+Serif+Hebrew:wght@100..900&family=Noto+Naskh+Arabic:wght@400..700&family=Noto+Serif+JP&family=Noto+Serif+KR&family=Noto+Serif+SC&family=Noto+Serif+TC&family=Noto+Serif+Thai:wght@100..900&family=Noto+Serif:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

  <script data-goatcounter="https://zansaradev.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="/">
      <img src="https://www.zansara.dev/me/avatar.svg" style="width: 1em; height: 1em; margin-right: 5px;">
      Sara Zan&#39;s Blog
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list" >
        
          
            <li class="navigation-item">
              <a class="navigation-link" style="height: 30px;" href="/about">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" style="height: 30px;" href="/posts/">Posts</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" style="height: 30px;" href="/projects/">Projects</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" style="height: 30px;" href="/publications/">Publications</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" style="height: 30px;" href="/talks/">Talks</a>
            </li>
          
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://www.zansara.dev/posts/2024-01-06-raspberrypi-headless-bookworm-wifi-config/">
              Headless WiFi setup on Raspberry Pi OS &#34;Bookworm&#34; without the Raspberry Pi Imager
            </a>
          </h1>
          <p style="margin-bottom:0; color:#777;">
            Setting up a headless Pi used to be simpler. Is it still possible to do it without the RPi Imager?
          </p>
        </div>
        <div class="post-meta">
          <div class="date" style="font-style: italic; margin-bottom: 2rem; line-height: 0.8; font-size: medium; color:#777;">
            <span class="posted-on">
              
              <time datetime="2024-01-06T00:00:00Z">
                by <a href="/">Sara Zan</a>, January 6, 2024
              </time>
            </span>
            
          </div>
          
          
          
        </div>
      </header>

      <div class="post-content">
        
          <img style="width:100%;" src="/posts/2024-01-06-raspberrypi-headless-bookworm-wifi-config/cover.png" alt="Featured image"/>
        
        <div style="padding: 5px 15px; font-family: sans; font-style: italic;">
  <p style="margin:5px 0 10px 0;"><a href="/posts/2024-01-06-raspberrypi-headless-bookworm-wifi-config/Headless%20WiFi%20setup%20on%20Raspberry%20Pi%20OS%20Bookworm%20without%20the%20Raspberry%20Pi%20Imager%20-%20Sara%20Zan.mp3">Listen to this article</a> or <a href="https://app.speechify.com/share/6a234a55-265b-4a94-82e7-57bbb05b738e?utm_campaign=partners&utm_content=rewardful&via=zansaradev-blog" target="_blank">read it in the app</a>:</p>
  <audio controls style="width:100%;">
    <source src="/posts/2024-01-06-raspberrypi-headless-bookworm-wifi-config/Headless%20WiFi%20setup%20on%20Raspberry%20Pi%20OS%20Bookworm%20without%20the%20Raspberry%20Pi%20Imager%20-%20Sara%20Zan.mp3" type="audio/mpeg">
  </audio> 
  <div style="text-align:right;vertical-align:middle;">
    <span style="font-style: italic;">Powered by</span>
    <a href="https://speechify.com/text-to-speech-online/?utm_campaign=partners&utm_content=rewardful&via=zansaradev-blog" target="_blank" style="display:inline;margin-left:5px;"><img src="/global/speechify_logo.svg" alt="Speechify" style="width:150px;background-color:white;margin:0;vertical-align:middle;"/></a>
  </div>
</div>

<p>Setting up a Raspberry Pi headless without the Raspberry Pi Imager used to be a fairly simple process for the average Linux user, to the point where a how-to and a few searches on the Raspberry Pi forums would sort the process out. After flashing the image with <code>dd</code>, creating <code>ssh</code> in the boot partition and populating <code>wpa_supplicant.conf</code> was normally enough to get started.</p>
<p>However with the <a href="https://www.raspberrypi.com/news/bookworm-the-new-version-of-raspberry-pi-os/"  class="external-link" target="_blank" rel="noopener">recently released Raspberry Pi OS 12 &ldquo;Bookworm&rdquo;</a> this second step <a href="https://www.raspberrypi.com/documentation/computers/configuration.html#connect-to-a-wireless-network"  class="external-link" target="_blank" rel="noopener">doesn&rsquo;t work anymore</a> and the only recommendation that users receive is to &ldquo;just use the Raspberry Pi Imager&rdquo; (like <a href="https://github.com/raspberrypi/bookworm-feedback/issues/72"  class="external-link" target="_blank" rel="noopener">here</a>).</p>
<p>But what does the Imager really do to configure the OS? Is it really that complex that it requires downloading a dedicated installer?</p>
<p>In this post I&rsquo;m going to find out first how to get the OS connect to the WiFi without Imager, and then I&rsquo;m going to dig a bit deeper to find out why such advice is given and how the Imager performs this configuration step.</p>
<h1 id="network-manager">
  Network Manager
  
</h1>
<p>In the <a href="https://www.raspberrypi.com/news/bookworm-the-new-version-of-raspberry-pi-os/"  class="external-link" target="_blank" rel="noopener">announcement</a> of the new OS release, one of the highlights is the move to <a href="https://networkmanager.dev/"  class="external-link" target="_blank" rel="noopener">NetworkManager</a> as the default mechanism to deal with networking. While this move undoubtely brings many advantages, it is the reason why the classic technique of dropping a <code>wpa_supplicant.conf</code> file under <code>/etc/wpa_supplicant/</code> no longer works.</p>
<p>The good news is that also NetworkManager can be manually configured with a text file. The file needs to be called <code>SSID.nmconnection</code> (replace <code>SSID</code> with your network&rsquo;s SSID) and placed under <code>/etc/NetworkManager/system-connections/</code> in the Pi&rsquo;s <code>rootfs</code> partition.</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[connection]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>id=SSID
</span></span><span style="display:flex;"><span>uuid= <span style="color:#8b949e;font-style:italic"># random UUID in the format 11111111-1111-1111-1111-111111111111</span>
</span></span><span style="display:flex;"><span>type=wifi
</span></span><span style="display:flex;"><span>autoconnect=<span style="color:#79c0ff">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[wifi]
</span></span><span style="display:flex;"><span>mode=infrastructure
</span></span><span style="display:flex;"><span>ssid=SSID
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[wifi-security]
</span></span><span style="display:flex;"><span>auth-alg=open
</span></span><span style="display:flex;"><span>key-mgmt=wpa-psk
</span></span><span style="display:flex;"><span>psk=PASSWORD
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[ipv4]
</span></span><span style="display:flex;"><span>method=auto
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[ipv6]
</span></span><span style="display:flex;"><span>method=auto
</span></span></code></pre></div><p>(replace <code>SSID</code> and <code>PASSWORD</code> with your wifi network&rsquo;s SSID and password). <a href="https://developer-old.gnome.org/NetworkManager/stable/nm-settings-keyfile.html"  class="external-link" target="_blank" rel="noopener">Here</a> you can find the full syntax for this file.</p>
<p>You&rsquo;ll need also to configure its access rights as:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo chmod -R <span style="color:#a5d6ff">600</span> &lt;path-to-rootfs&gt;/etc/NetworkManager/system-connections/SSID.nmconnection
</span></span><span style="display:flex;"><span>sudo chown -R root:root &lt;path-to-rootfs&gt;/etc/NetworkManager/system-connections/SSID.nmconnection
</span></span></code></pre></div><p>Once this is done, let&rsquo;s not forget to create an empty <code>ssh</code> file in the <code>bootfs</code> partition to enable the SSH server:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>touch &lt;path-to-bootfs&gt;/ssh
</span></span></code></pre></div><p>and, as it was already the case in Bullseye to <a href="https://www.raspberrypi.com/news/raspberry-pi-bullseye-update-april-2022/"  class="external-link" target="_blank" rel="noopener">configure the default user</a> with <code>userconfig.txt</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#a5d6ff">&#39;mypassword&#39;</span> | openssl passwd -6 -stdin | awk <span style="color:#a5d6ff">&#39;{print &#34;myuser:&#34;$1}&#39;</span> &gt; &lt;path-to-bootfs&gt;/userconfig.txt
</span></span></code></pre></div><p>So far it doesn&rsquo;t seem too complicated. However, interestingly, this is <strong>not</strong> what the Raspberry Pi Imager does, because if you use it to flash the image and check the result, these files are nowhere to be found. Is there a better way to go about this?</p>
<h1 id="raspberry-pi-imager">
  Raspberry Pi Imager
  
</h1>
<p>To find out what the Imager does, my first idea was to have a peek at its <a href="https://github.com/raspberrypi/rpi-imager"  class="external-link" target="_blank" rel="noopener">source code</a>. Being a Qt application the source might be quite intimidating, but with a some searching it&rsquo;s possible to locate this interesting <a href="https://github.com/raspberrypi/rpi-imager/blob/6f6a90adbb88c135534d5f20cc2a10f167ea43a3/src/imagewriter.cpp#L1214"  class="external-link" target="_blank" rel="noopener">snippet</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff7b72">void</span> ImageWriter<span style="color:#ff7b72;font-weight:bold">::</span>setImageCustomization(<span style="color:#ff7b72">const</span> QByteArray <span style="color:#ff7b72;font-weight:bold">&amp;</span>config, <span style="color:#ff7b72">const</span> QByteArray <span style="color:#ff7b72;font-weight:bold">&amp;</span>cmdline, <span style="color:#ff7b72">const</span> QByteArray <span style="color:#ff7b72;font-weight:bold">&amp;</span>firstrun, <span style="color:#ff7b72">const</span> QByteArray <span style="color:#ff7b72;font-weight:bold">&amp;</span>cloudinit, <span style="color:#ff7b72">const</span> QByteArray <span style="color:#ff7b72;font-weight:bold">&amp;</span>cloudinitNetwork)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    _config <span style="color:#ff7b72;font-weight:bold">=</span> config;
</span></span><span style="display:flex;"><span>    _cmdline <span style="color:#ff7b72;font-weight:bold">=</span> cmdline;
</span></span><span style="display:flex;"><span>    _firstrun <span style="color:#ff7b72;font-weight:bold">=</span> firstrun;
</span></span><span style="display:flex;"><span>    _cloudinit <span style="color:#ff7b72;font-weight:bold">=</span> cloudinit;
</span></span><span style="display:flex;"><span>    _cloudinitNetwork <span style="color:#ff7b72;font-weight:bold">=</span> cloudinitNetwork;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    qDebug() <span style="color:#ff7b72;font-weight:bold">&lt;&lt;</span> <span style="color:#a5d6ff">&#34;Custom config.txt entries:&#34;</span> <span style="color:#ff7b72;font-weight:bold">&lt;&lt;</span> config;
</span></span><span style="display:flex;"><span>    qDebug() <span style="color:#ff7b72;font-weight:bold">&lt;&lt;</span> <span style="color:#a5d6ff">&#34;Custom cmdline.txt entries:&#34;</span> <span style="color:#ff7b72;font-weight:bold">&lt;&lt;</span> cmdline;
</span></span><span style="display:flex;"><span>    qDebug() <span style="color:#ff7b72;font-weight:bold">&lt;&lt;</span> <span style="color:#a5d6ff">&#34;Custom firstuse.sh:&#34;</span> <span style="color:#ff7b72;font-weight:bold">&lt;&lt;</span> firstrun;
</span></span><span style="display:flex;"><span>    qDebug() <span style="color:#ff7b72;font-weight:bold">&lt;&lt;</span> <span style="color:#a5d6ff">&#34;Cloudinit:&#34;</span> <span style="color:#ff7b72;font-weight:bold">&lt;&lt;</span> cloudinit;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I&rsquo;m no C++ expert, but this function tells me a few things:</p>
<ol>
<li>The Imager writes the configuration in these files: <code>config.txt</code>, <code>cmdline.txt</code>, <code>firstuse.sh</code> (we&rsquo;ll soon figure out this is a typo: the file is actually called <code>firstrun.sh</code>).</li>
<li>It also prepares a &ldquo;Cloudinit&rdquo; configuration file, but it&rsquo;s unclear if it writes it and where</li>
<li>The content of these files is printed to the console as debug output.</li>
</ol>
<p>So let&rsquo;s enable the debug logs and see what they produce:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>rpi-imager --debug
</span></span></code></pre></div><p>The console stays quiet until I configure the user, password, WiFi and so on in the Imager, at which point it starts printing all the expected configuration files to the console.</p>
<details>
<summary><i>Click here to see the full output</i></summary>
<pre tabindex="0"><code>Custom config.txt entries: &#34;&#34;
Custom cmdline.txt entries: &#34; cfg80211.ieee80211_regdom=PT&#34;
Custom firstuse.sh: &#34;#!/bin/bash

set +e

CURRENT_HOSTNAME=`cat /etc/hostname | tr -d &#34; \    \
\\r&#34;`
if [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then
   /usr/lib/raspberrypi-sys-mods/imager_custom set_hostname raspberrypi
else
   echo raspberrypi &gt;/etc/hostname
   sed -i &#34;s/127.0.1.1.*$CURRENT_HOSTNAME/127.0.1.1\    raspberrypi/g&#34; /etc/hosts
fi
FIRSTUSER=`getent passwd 1000 | cut -d: -f1`
FIRSTUSERHOME=`getent passwd 1000 | cut -d: -f6`
if [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then
   /usr/lib/raspberrypi-sys-mods/imager_custom enable_ssh
else
   systemctl enable ssh
fi
if [ -f /usr/lib/userconf-pi/userconf ]; then
   /usr/lib/userconf-pi/userconf &#39;myuser&#39; &#39;&lt;hash-of-the-user-password&gt;&#39;
else
   echo &#34;$FIRSTUSER:&#34;&#39;&lt;hash-of-the-user-password&gt;&#39; | chpasswd -e
   if [ &#34;$FIRSTUSER&#34; != &#34;myuser&#34; ]; then
      usermod -l &#34;myuser&#34; &#34;$FIRSTUSER&#34;
      usermod -m -d &#34;/home/myuser&#34; &#34;myuser&#34;
      groupmod -n &#34;myuser&#34; &#34;$FIRSTUSER&#34;
      if grep -q &#34;^autologin-user=&#34; /etc/lightdm/lightdm.conf ; then
         sed /etc/lightdm/lightdm.conf -i -e &#34;s/^autologin-user=.*/autologin-user=myuser/&#34;
      fi
      if [ -f /etc/systemd/system/getty@tty1.service.d/autologin.conf ]; then
         sed /etc/systemd/system/getty@tty1.service.d/autologin.conf -i -e &#34;s/$FIRSTUSER/myuser/&#34;
      fi
      if [ -f /etc/sudoers.d/010_pi-nopasswd ]; then
         sed -i &#34;s/^$FIRSTUSER /myuser /&#34; /etc/sudoers.d/010_pi-nopasswd
      fi
   fi
fi
if [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then
   /usr/lib/raspberrypi-sys-mods/imager_custom set_wlan &#39;MY-SSID&#39; &#39;MY-PASSWORD&#39; &#39;PT&#39;
else
cat &gt;/etc/wpa_supplicant/wpa_supplicant.conf &lt;&lt;&#39;WPAEOF&#39;
country=PT
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
ap_scan=1

update_config=1
network={
    ssid=&#34;MY-SSID&#34;
    psk=MY-PASSWORD
}

WPAEOF
   chmod 600 /etc/wpa_supplicant/wpa_supplicant.conf
   rfkill unblock wifi
   for filename in /var/lib/systemd/rfkill/*:wlan ; do
       echo 0 &gt; $filename
   done
fi
if [ -f /usr/lib/raspberrypi-sys-mods/imager_custom ]; then
   /usr/lib/raspberrypi-sys-mods/imager_custom set_keymap &#39;us&#39;
   /usr/lib/raspberrypi-sys-mods/imager_custom set_timezone &#39;Europe/Lisbon&#39;
else
   rm -f /etc/localtime
   echo &#34;Europe/Lisbon&#34; &gt;/etc/timezone
   dpkg-reconfigure -f noninteractive tzdata
cat &gt;/etc/default/keyboard &lt;&lt;&#39;KBEOF&#39;
XKBMODEL=&#34;pc105&#34;
XKBLAYOUT=&#34;us&#34;
XKBVARIANT=&#34;&#34;
XKBOPTIONS=&#34;&#34;

KBEOF
   dpkg-reconfigure -f noninteractive keyboard-configuration
fi
rm -f /boot/firstrun.sh
sed -i &#39;s| systemd.run.*||g&#39; /boot/cmdline.txt
exit 0
&#34;

Cloudinit: &#34;hostname: raspberrypi
manage_etc_hosts: true
packages:
- avahi-daemon
apt:
  conf: |
    Acquire {
      Check-Date &#34;false&#34;;
    };

users:
- name: myuser
  groups: users,adm,dialout,audio,netdev,video,plugdev,cdrom,games,input,gpio,spi,i2c,render,sudo
  shell: /bin/bash
  lock_passwd: false
  passwd: &lt;hash-of-the-user-password&gt;

ssh_pwauth: true

timezone: Europe/Lisbon
runcmd:
- localectl set-x11-keymap &#34;us&#34; pc105
- setupcon -k --force || true


&#34;
</code></pre></details>
<p>Among these the most interesting file is <code>firstrun.sh</code>, which we can quickly locate in the <code>bootfs</code> partition. Here is its content:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span>set +e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#79c0ff">CURRENT_HOSTNAME</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">`</span>cat /etc/hostname | tr -d <span style="color:#a5d6ff">&#34; \    \
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">\\r&#34;</span><span style="color:#a5d6ff">`</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">[</span> -f /usr/lib/raspberrypi-sys-mods/imager_custom <span style="color:#ff7b72;font-weight:bold">]</span>; <span style="color:#ff7b72">then</span>
</span></span><span style="display:flex;"><span>   /usr/lib/raspberrypi-sys-mods/imager_custom set_hostname raspberrypi
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span>   echo raspberrypi &gt;/etc/hostname
</span></span><span style="display:flex;"><span>   sed -i <span style="color:#a5d6ff">&#34;s/127.0.1.1.*</span><span style="color:#79c0ff">$CURRENT_HOSTNAME</span><span style="color:#a5d6ff">/127.0.1.1\    raspberrypi/g&#34;</span> /etc/hosts
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#79c0ff">FIRSTUSER</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">`</span>getent passwd <span style="color:#a5d6ff">1000</span> | cut -d: -f1<span style="color:#a5d6ff">`</span>
</span></span><span style="display:flex;"><span><span style="color:#79c0ff">FIRSTUSERHOME</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">`</span>getent passwd <span style="color:#a5d6ff">1000</span> | cut -d: -f6<span style="color:#a5d6ff">`</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">[</span> -f /usr/lib/raspberrypi-sys-mods/imager_custom <span style="color:#ff7b72;font-weight:bold">]</span>; <span style="color:#ff7b72">then</span>
</span></span><span style="display:flex;"><span>   /usr/lib/raspberrypi-sys-mods/imager_custom enable_ssh
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span>   systemctl enable ssh
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">[</span> -f /usr/lib/userconf-pi/userconf <span style="color:#ff7b72;font-weight:bold">]</span>; <span style="color:#ff7b72">then</span>
</span></span><span style="display:flex;"><span>   /usr/lib/userconf-pi/userconf <span style="color:#a5d6ff">&#39;myuser&#39;</span> <span style="color:#a5d6ff">&#39;&lt;hash-of-the-user-password&gt;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span>   echo <span style="color:#a5d6ff">&#34;</span><span style="color:#79c0ff">$FIRSTUSER</span><span style="color:#a5d6ff">:&#34;</span><span style="color:#a5d6ff">&#39;&lt;hash-of-the-user-password&gt;&#39;</span> | chpasswd -e
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">[</span> <span style="color:#a5d6ff">&#34;</span><span style="color:#79c0ff">$FIRSTUSER</span><span style="color:#a5d6ff">&#34;</span> !<span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;myuser&#34;</span> <span style="color:#ff7b72;font-weight:bold">]</span>; <span style="color:#ff7b72">then</span>
</span></span><span style="display:flex;"><span>      usermod -l <span style="color:#a5d6ff">&#34;myuser&#34;</span> <span style="color:#a5d6ff">&#34;</span><span style="color:#79c0ff">$FIRSTUSER</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span>      usermod -m -d <span style="color:#a5d6ff">&#34;/home/myuser&#34;</span> <span style="color:#a5d6ff">&#34;myuser&#34;</span>
</span></span><span style="display:flex;"><span>      groupmod -n <span style="color:#a5d6ff">&#34;myuser&#34;</span> <span style="color:#a5d6ff">&#34;</span><span style="color:#79c0ff">$FIRSTUSER</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff7b72">if</span> grep -q <span style="color:#a5d6ff">&#34;^autologin-user=&#34;</span> /etc/lightdm/lightdm.conf ; <span style="color:#ff7b72">then</span>
</span></span><span style="display:flex;"><span>         sed /etc/lightdm/lightdm.conf -i -e <span style="color:#a5d6ff">&#34;s/^autologin-user=.*/autologin-user=myuser/&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff7b72">fi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">[</span> -f /etc/systemd/system/getty@tty1.service.d/autologin.conf <span style="color:#ff7b72;font-weight:bold">]</span>; <span style="color:#ff7b72">then</span>
</span></span><span style="display:flex;"><span>         sed /etc/systemd/system/getty@tty1.service.d/autologin.conf -i -e <span style="color:#a5d6ff">&#34;s/</span><span style="color:#79c0ff">$FIRSTUSER</span><span style="color:#a5d6ff">/myuser/&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff7b72">fi</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">[</span> -f /etc/sudoers.d/010_pi-nopasswd <span style="color:#ff7b72;font-weight:bold">]</span>; <span style="color:#ff7b72">then</span>
</span></span><span style="display:flex;"><span>         sed -i <span style="color:#a5d6ff">&#34;s/^</span><span style="color:#79c0ff">$FIRSTUSER</span><span style="color:#a5d6ff"> /myuser /&#34;</span> /etc/sudoers.d/010_pi-nopasswd
</span></span><span style="display:flex;"><span>      <span style="color:#ff7b72">fi</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">[</span> -f /usr/lib/raspberrypi-sys-mods/imager_custom <span style="color:#ff7b72;font-weight:bold">]</span>; <span style="color:#ff7b72">then</span>
</span></span><span style="display:flex;"><span>   /usr/lib/raspberrypi-sys-mods/imager_custom set_wlan <span style="color:#a5d6ff">&#39;MY-SSID&#39;</span> <span style="color:#a5d6ff">&#39;MY-PASSWORD&#39;</span> <span style="color:#a5d6ff">&#39;PT&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span>cat &gt;/etc/wpa_supplicant/wpa_supplicant.conf <span style="color:#a5d6ff">&lt;&lt;&#39;WPAEOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">country=PT
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">ap_scan=1
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">update_config=1
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">network={
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    ssid=&#34;MY-SSID&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">    psk=MY-PASSWORD
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">}
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">WPAEOF</span>
</span></span><span style="display:flex;"><span>   chmod <span style="color:#a5d6ff">600</span> /etc/wpa_supplicant/wpa_supplicant.conf
</span></span><span style="display:flex;"><span>   rfkill unblock wifi
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">for</span> filename in /var/lib/systemd/rfkill/*:wlan ; <span style="color:#ff7b72">do</span>
</span></span><span style="display:flex;"><span>       echo <span style="color:#a5d6ff">0</span> &gt; <span style="color:#79c0ff">$filename</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">done</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">[</span> -f /usr/lib/raspberrypi-sys-mods/imager_custom <span style="color:#ff7b72;font-weight:bold">]</span>; <span style="color:#ff7b72">then</span>
</span></span><span style="display:flex;"><span>   /usr/lib/raspberrypi-sys-mods/imager_custom set_keymap <span style="color:#a5d6ff">&#39;us&#39;</span>
</span></span><span style="display:flex;"><span>   /usr/lib/raspberrypi-sys-mods/imager_custom set_timezone <span style="color:#a5d6ff">&#39;Europe/Lisbon&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span>   rm -f /etc/localtime
</span></span><span style="display:flex;"><span>   echo <span style="color:#a5d6ff">&#34;Europe/Lisbon&#34;</span> &gt;/etc/timezone
</span></span><span style="display:flex;"><span>   dpkg-reconfigure -f noninteractive tzdata
</span></span><span style="display:flex;"><span>cat &gt;/etc/default/keyboard <span style="color:#a5d6ff">&lt;&lt;&#39;KBEOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">XKBMODEL=&#34;pc105&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">XKBLAYOUT=&#34;us&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">XKBVARIANT=&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">XKBOPTIONS=&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">KBEOF</span>
</span></span><span style="display:flex;"><span>   dpkg-reconfigure -f noninteractive keyboard-configuration
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">fi</span>
</span></span><span style="display:flex;"><span>rm -f /boot/firstrun.sh
</span></span><span style="display:flex;"><span>sed -i <span style="color:#a5d6ff">&#39;s| systemd.run.*||g&#39;</span> /boot/cmdline.txt
</span></span><span style="display:flex;"><span>exit <span style="color:#a5d6ff">0</span>
</span></span></code></pre></div><details>
<summary> <i>Side note: how does the OS know that it should run this file on  its first boot? </i></summary>
<p>Imager also writes a file called <code>cmdline.txt</code> in the boot partition, which contains the following:</p>
<pre tabindex="0"><code>console=serial0,115200 console=tty1 root=PARTUUID=57c84f67-02 rootfstype=ext4 fsck.repair=yes rootwait quiet init=/usr/lib/raspberrypi-sys-mods/firstboot cfg80211.ieee80211_regdom=PT systemd.run=/boot/firstrun.sh systemd.run_success_action=reboot systemd.unit=kernel-command-line.target
</code></pre><p>Note the reference to <code>/boot/firstrun.sh</code>. If you plan to implement your own <code>firstrun.sh</code> file and want to change its name, don&rsquo;t forget to modify this line as well.</p>
</details>
<p>That&rsquo;s a lot of Bash in one go, but upon inspection one can spot a recurring pattern. For example, when setting the hostname, it does this:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">[</span> -f /usr/lib/raspberrypi-sys-mods/imager_custom <span style="color:#ff7b72;font-weight:bold">]</span>; <span style="color:#ff7b72">then</span>
</span></span><span style="display:flex;"><span>   /usr/lib/raspberrypi-sys-mods/imager_custom set_hostname raspberrypi
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span>   echo raspberrypi &gt;/etc/hostname
</span></span><span style="display:flex;"><span>   sed -i <span style="color:#a5d6ff">&#34;s/127.0.1.1.*</span><span style="color:#79c0ff">$CURRENT_HOSTNAME</span><span style="color:#a5d6ff">/127.0.1.1\    raspberrypi/g&#34;</span> /etc/hosts
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">fi</span>
</span></span></code></pre></div><p>The script clearly messages that there is a &ldquo;preferred&rdquo; way to set the hostname: to use <code>/usr/lib/raspberrypi-sys-mods/imager_custom set_hostname [NAME]</code>. Only if this executable is not available, then it falls back to the &ldquo;traditional&rdquo; way of setting the hostname by editing <code>/etc/hosts</code>.</p>
<p>The same patterns repeat a few times to perform the following operations:</p>
<ul>
<li>set the hostname (<code>/usr/lib/raspberrypi-sys-mods/imager_custom set_hostname [NAME]</code>)</li>
<li>enable ssh (<code>/usr/lib/raspberrypi-sys-mods/imager_custom enable_ssh</code>)</li>
<li>configure the user (<code>/usr/lib/userconf-pi/userconf [USERNAME] [HASHED-PASSWORD]</code>)</li>
<li>configure the WiFi (<code>/usr/lib/raspberrypi-sys-mods/imager_custom set_wlan [MY-SSID [MY-PASSWORD] [2-LETTER-COUNTRY-CODE]</code>)</li>
<li>set the keyboard layout (<code>/usr/lib/raspberrypi-sys-mods/imager_custom set_keymap [CODE]</code>)</li>
<li>set the timezone (<code>/usr/lib/raspberrypi-sys-mods/imager_custom set_timezone [TIMEZONE-NAME]</code>)</li>
</ul>
<p>It seems like using <code>raspberrypi-sys-mods</code> to configure the OS at the first boot is the way to go in this RPi OS version, and it might be true in future versions as well. There are <a href="https://github.com/RPi-Distro/raspberrypi-sys-mods/issues/82#issuecomment-1779109991"  class="external-link" target="_blank" rel="noopener">hints</a> that the Raspberry PI OS team is going to move to <a href="https://cloudinit.readthedocs.io/en/latest/index.html"  class="external-link" target="_blank" rel="noopener"><code>cloud-init</code></a> in the near future, but for now this seems to be the way that the initial setup is done.</p>
<h1 id="raspberrypi-sys-mods">
  raspberrypi-sys-mods
  
</h1>
<p>So let&rsquo;s check out what <code>raspberrypi-sys-mods</code> do! The source code can be found here: <a href="https://github.com/RPi-Distro/raspberrypi-sys-mods"  class="external-link" target="_blank" rel="noopener">raspberrypi-sys-mods</a>.</p>
<p>Given that we&rsquo;re interested in the WiFi configuration, let&rsquo;s head straight to the <code>imager_custom</code> script (<a href="https://github.com/RPi-Distro/raspberrypi-sys-mods/blob/2e256445b65995f62db80e6a267313275cad51e4/usr/lib/raspberrypi-sys-mods/imager_custom#L97"  class="external-link" target="_blank" rel="noopener">here</a>), where we discover that it&rsquo;s a Bash script which does this:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#79c0ff">CONNFILE</span><span style="color:#ff7b72;font-weight:bold">=</span>/etc/NetworkManager/system-connections/preconfigured.nmconnection
</span></span><span style="display:flex;"><span>  <span style="color:#79c0ff">UUID</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#ff7b72">$(</span>uuid -v4<span style="color:#ff7b72">)</span>
</span></span><span style="display:flex;"><span>  cat <span style="color:#a5d6ff">&lt;&lt;- EOF &gt;${CONNFILE}
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	[connection]
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	id=preconfigured
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	uuid=${UUID}
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	type=wifi
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	[wifi]
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	mode=infrastructure
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	ssid=${SSID}
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	hidden=${HIDDEN}
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	[ipv4]
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	method=auto
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	[ipv6]
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	addr-gen-mode=default
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	method=auto
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	[proxy]
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">if</span> <span style="color:#ff7b72;font-weight:bold">[</span> ! -z <span style="color:#a5d6ff">&#34;</span><span style="color:#a5d6ff">${</span><span style="color:#79c0ff">PASS</span><span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">&#34;</span> <span style="color:#ff7b72;font-weight:bold">]</span>; <span style="color:#ff7b72">then</span>
</span></span><span style="display:flex;"><span>    cat <span style="color:#a5d6ff">&lt;&lt;- EOF &gt;&gt;${CONNFILE}
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	[wifi-security]
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	key-mgmt=wpa-psk
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	psk=${PASS}
</span></span></span><span style="display:flex;"><span><span style="color:#a5d6ff">	EOF</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8b949e;font-style:italic"># NetworkManager will ignore nmconnection files with incorrect permissions,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8b949e;font-style:italic"># to prevent Wi-Fi credentials accidentally being world-readable.</span>
</span></span><span style="display:flex;"><span>  chmod <span style="color:#a5d6ff">600</span> <span style="color:#a5d6ff">${</span><span style="color:#79c0ff">CONNFILE</span><span style="color:#a5d6ff">}</span>
</span></span></code></pre></div><p>So after all this searching, we&rsquo;re back to square one. This utility is doing exactly what we&rsquo;ve done at the start: it writes a NetworkManager configuration file called <code>preconfigured.nmconnection</code> and it fills it in with the information that we&rsquo;ve provided to the Imager, then changes the permissions to make sure NetworkManager can use it.</p>
<h1 id="conclusion">
  Conclusion
  
</h1>
<p>It would be great if the Raspberry Pi OS team would expand their documentation to include this information, so that users aren&rsquo;t left wondering what makes the RPi Imager so special and whether their manual setup is the right way to go or rather a hack that is likely to break. For now it seems like there is one solid good approach to this problem, and we are going to see what is going to change in the next version of the Raspberry Pi OS.</p>
<p>On this note you should remember that doing a manual configuration of NetworkManager, using the Imager, or using <code>raspberrypi-sys-mods</code> may be nearly identical right now, but when choosing which approach to use for your project you should also keep in mind the maintenance burden that this decision brings.</p>
<p>Doing a manual configuration is easier on many levels, but only if you don&rsquo;t intend to support other versions of RPi OS. If you do, or if you expect to migrate when a new version comes out, you should consider doing something similar to what the Imager does: use a <code>firstrun.sh</code> file that tries to use <code>raspberrypi-sys-mods</code> and falls back to a manual configuration only if that executable is missing. That is likely to make migrations easier if the Raspberry Pi OS team should choose once again to modify the way that headless setups work.</p>
<p class="fleuron"><a href="https://www.zansara.dev/posts/2024-05-06-teranoptia/">FÅ»</a></p>
      </div>

    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    Â©
    
      2023 -
    
    2025 by
    &MediumSpace;
    <a href="/"><img src="https://www.zansara.dev/me/avatar.svg" style="width: 1em; height: 1em; margin-right: 5px;">Sara Zan</a>
  </section>
</footer>

  </main>

  

  <script src="/js/coder.js"></script>

  

  
</body>

</html>
